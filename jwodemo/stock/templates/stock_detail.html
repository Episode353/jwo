{% extends 'template.html' %}

{% block title %}{{ stock.name }} - Stock Details{% endblock %}

{% block content %}

{% include 'widgets/stock_styles.html' %}

<div class="content-large-fill">
    <a href="{% url 'stock_home' %}" class="btn btn-outline-secondary mb-4">â†© Stocks</a>
    <h1 class="text-center stock-detail-name">{{ stock.name }}</h1>

    {% include 'widgets/stock_table.html' with stocks=stock_list show_last_updated=True %}

    <h2 class="text-center my-4">Stock History Graph</h2>
    {% include 'widgets/stock_chart.html' with stock_data=stock_data chart_type='stock_detail' %}

    {% if messages %}
        <div class="alert alert-danger text-center" role="alert">
            {% for message in messages %}
                {{ message }}<br>
            {% endfor %}
        </div>
    {% endif %}

    {% if user.is_authenticated %}


             <!-- Show the "Edit Stock" button only if the logged-in user is the creator -->
            {% if is_creator %}
                <p class="text-center">
                    <a href="{% url 'edit_stock' stock.id %}" class="btn btn-warning">Edit Stock</a>
                </p>
            {% endif %}

        {% if ownership %}
            <!-- Display Ownership Information -->
            <p class="text-center">You own {{ ownership.quantity }} units of {{ stock.name }}.</p>




            <!-- Sell Form -->
            <form action="{% url 'sell_stock' stock.id %}" method="POST" class="text-center">
                {% csrf_token %}
                <div class="form-row align-items-center justify-content-center" style="border: none !important;">
                    <div class="col-auto" style="border: none !important;">
                        <label for="sell-quantity" class="sr-only">Quantity:</label>
                        <input type="number" id="sell-quantity" name="quantity" class="form-control mb-2" min="1" max="{{ ownership.quantity }}" required placeholder="Quantity">
                    </div>
                    <div class="col-auto" style="border: none !important;">
                        <p id="sell-cost-display" class="mb-2">Total Revenue: 0 Seep Coins</p>
                    </div>
                    <div class="col-auto" style="border: none !important;">
                        <button type="submit" class="btn btn-danger btn-lg mb-2">Sell</button>
                    </div>
                </div>
            </form>
        {% else %}
            <!-- No Ownership Information -->
            <p class="text-center">You do not own any units of this stock.</p>
        {% endif %}

        <!-- Buy Form -->
        <form action="{% url 'buy_stock' stock.id %}" method="POST" class="text-center mt-4">
            {% csrf_token %}
            <div class="form-row align-items-center justify-content-center" style="border: none !important;">
                <div class="col-auto" style="border: none !important;">
                    <label for="buy-quantity" class="sr-only">Quantity:</label>
                    <input type="number" id="buy-quantity" name="quantity" class="form-control mb-2" min="1" max="{{ user.profile.coin_count }}" required placeholder="Quantity">
                </div>
                <div class="col-auto" style="border: none !important;">
                    <p id="buy-cost-display" class="mb-2">Total Cost: 0 Seep Coins</p>
                </div>
                <div class="col-auto" style="border: none !important;">
                    <button type="submit" class="btn btn-primary btn-lg mb-2">Buy</button>
                </div>
            </div>
        </form>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const buyQuantityInput = document.getElementById('buy-quantity');
                const buyCostDisplay = document.getElementById('buy-cost-display');
                const sellQuantityInput = document.getElementById('sell-quantity');
                const sellCostDisplay = document.getElementById('sell-cost-display');
                const stockValue = {{ stock.value|floatformat:2 }}; // Use floatformat to ensure correct decimal precision

                function updateBuyCost() {
                    const quantity = parseInt(buyQuantityInput.value, 10) || 0;
                    const totalCost = (stockValue * quantity).toFixed(2);
                    buyCostDisplay.textContent = `Total Cost: ${totalCost} Seep Coins`;
                }

                function updateSellCost() {
                    const quantity = parseInt(sellQuantityInput.value, 10) || 0;
                    const totalRevenue = (stockValue * quantity).toFixed(2);
                    sellCostDisplay.textContent = `Total Revenue: ${totalRevenue} Seep Coins`;
                }

                buyQuantityInput.addEventListener('input', updateBuyCost);
                sellQuantityInput.addEventListener('input', updateSellCost);
            });
        </script>

    {% else %}
        <!-- Not Authenticated -->
        <p class="text-center">You need to <a href="{% url 'login' %}">log in</a> to buy or sell stocks.</p>
    {% endif %}

</div>

{% endblock %}
